# Custom Pricing System - Architecture Overview

## ğŸ—ï¸ System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ADMIN DASHBOARD                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚           User Detail Page [userId].js                â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
â”‚  â”‚  â”‚         CUSTOM PRICING TAB                  â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  â”‚  â€¢ List existing custom pricing     â”‚   â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  â”‚  â€¢ Add new pricing button           â”‚   â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  â”‚  â€¢ Edit/Delete actions              â”‚   â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  â”‚  â€¢ Default pricing reference        â”‚   â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚     â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ API Calls
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API LAYER (Next.js)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚    /api/admin/custom-pricing.js                       â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
â”‚  â”‚  â”‚  GET    - Fetch pricing for user            â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  POST   - Create/Update pricing             â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  DELETE - Remove pricing                    â”‚     â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
â”‚  â”‚                                                        â”‚    â”‚
â”‚  â”‚  Authentication: Bearer Token                         â”‚    â”‚
â”‚  â”‚  Authorization: Admin Role Check                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ Database Queries
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATABASE (Supabase)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚           custom_pricing TABLE                         â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
â”‚  â”‚  â”‚  id              UUID                        â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  user_id         UUID â†’ profiles.id         â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  plan_name       TEXT                        â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  price_per_page  NUMERIC(10,2)              â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  currency        TEXT                        â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  notes           TEXT                        â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  created_by      UUID â†’ profiles.id         â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  created_at      TIMESTAMP                   â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  updated_at      TIMESTAMP                   â”‚     â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
â”‚  â”‚                                                        â”‚    â”‚
â”‚  â”‚  RLS Policies: Admin + User self-view                 â”‚    â”‚
â”‚  â”‚  Indexes: user_id, plan_name                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Data Flow Diagram

### Creating Custom Pricing

```
  Admin                UI Component           API Endpoint          Database
    â”‚                      â”‚                       â”‚                   â”‚
    â”‚  1. Click Add        â”‚                       â”‚                   â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                       â”‚                   â”‚
    â”‚                      â”‚                       â”‚                   â”‚
    â”‚  2. Fill Form        â”‚                       â”‚                   â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                       â”‚                   â”‚
    â”‚                      â”‚                       â”‚                   â”‚
    â”‚  3. Click Save       â”‚                       â”‚                   â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                       â”‚                   â”‚
    â”‚                      â”‚  4. POST /api/...     â”‚                   â”‚
    â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                   â”‚
    â”‚                      â”‚    + Auth Token       â”‚  5. Verify Admin  â”‚
    â”‚                      â”‚    + Pricing Data     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                      â”‚                       â”‚                   â”‚
    â”‚                      â”‚                       â”‚  6. Insert Record â”‚
    â”‚                      â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                      â”‚                       â”‚                   â”‚
    â”‚                      â”‚                       â”‚  7. Return Data   â”‚
    â”‚                      â”‚  8. Success Response  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚  9. Show Success     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚                   â”‚
    â”‚                      â”‚                       â”‚                   â”‚
    â”‚ 10. Refresh List     â”‚                       â”‚                   â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                       â”‚                   â”‚
    â”‚                      â”‚ 11. GET /api/...      â”‚                   â”‚
    â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                   â”‚
    â”‚                      â”‚                       â”‚ 12. Query         â”‚
    â”‚                      â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                      â”‚                       â”‚ 13. Results       â”‚
    â”‚                      â”‚ 14. Updated List      â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚ 15. Display          â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚                   â”‚
```

## ğŸ” Security Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SECURITY LAYERS                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚  Layer 1: Authentication                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  â€¢ Supabase Auth (JWT Token)                     â”‚    â”‚
â”‚  â”‚  â€¢ Bearer Token in Headers                       â”‚    â”‚
â”‚  â”‚  â€¢ Session Validation                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                          â†“                                 â”‚
â”‚  Layer 2: Authorization                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  â€¢ Check user.role === 'admin'                   â”‚    â”‚
â”‚  â”‚  â€¢ Verify in profiles table                      â”‚    â”‚
â”‚  â”‚  â€¢ Block non-admin access                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                          â†“                                 â”‚
â”‚  Layer 3: Row Level Security (RLS)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Policy 1: Admins can SELECT all                â”‚    â”‚
â”‚  â”‚  Policy 2: Admins can INSERT                     â”‚    â”‚
â”‚  â”‚  Policy 3: Admins can UPDATE                     â”‚    â”‚
â”‚  â”‚  Policy 4: Admins can DELETE                     â”‚    â”‚
â”‚  â”‚  Policy 5: Users can SELECT own pricing          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                          â†“                                 â”‚
â”‚  Layer 4: Data Validation                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  â€¢ Required field checks                         â”‚    â”‚
â”‚  â”‚  â€¢ Data type validation                          â”‚    â”‚
â”‚  â”‚  â€¢ Unique constraint (user_id + plan_name)       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ Component Hierarchy

```
pages/dashboard/admin/user/[userId].js
â”‚
â”œâ”€â”€ State Management
â”‚   â”œâ”€â”€ customPricing (array)
â”‚   â”œâ”€â”€ showPricingModal (boolean)
â”‚   â”œâ”€â”€ editingPricing (object|null)
â”‚   â”œâ”€â”€ pricingForm (object)
â”‚   â””â”€â”€ savingPricing (boolean)
â”‚
â”œâ”€â”€ Functions
â”‚   â”œâ”€â”€ fetchCustomPricing()
â”‚   â”œâ”€â”€ handleSaveCustomPricing()
â”‚   â”œâ”€â”€ handleDeletePricing()
â”‚   â”œâ”€â”€ handleEditPricing()
â”‚   â””â”€â”€ handleAddNewPricing()
â”‚
â”œâ”€â”€ UI Components
â”‚   â”œâ”€â”€ Custom Pricing Tab
â”‚   â”‚   â”œâ”€â”€ Header with Add Button
â”‚   â”‚   â”œâ”€â”€ Pricing List (if exists)
â”‚   â”‚   â”‚   â””â”€â”€ Pricing Cards
â”‚   â”‚   â”‚       â”œâ”€â”€ Plan Info
â”‚   â”‚   â”‚       â”œâ”€â”€ Price Display
â”‚   â”‚   â”‚       â”œâ”€â”€ Notes
â”‚   â”‚   â”‚       â”œâ”€â”€ Metadata
â”‚   â”‚   â”‚       â”œâ”€â”€ Edit Button
â”‚   â”‚   â”‚       â””â”€â”€ Delete Button
â”‚   â”‚   â”œâ”€â”€ Empty State (if no pricing)
â”‚   â”‚   â””â”€â”€ Default Pricing Reference
â”‚   â”‚
â”‚   â””â”€â”€ Pricing Modal
â”‚       â”œâ”€â”€ Header
â”‚       â”œâ”€â”€ Form Fields
â”‚       â”‚   â”œâ”€â”€ Plan Dropdown
â”‚       â”‚   â”œâ”€â”€ Price Input
â”‚       â”‚   â”œâ”€â”€ Currency Select
â”‚       â”‚   â””â”€â”€ Notes Textarea
â”‚       â””â”€â”€ Action Buttons
â”‚           â”œâ”€â”€ Cancel
â”‚           â””â”€â”€ Save
â”‚
â””â”€â”€ Helper Imports
    â””â”€â”€ lib/custom-pricing.js
        â”œâ”€â”€ getCustomPricing()
        â”œâ”€â”€ saveCustomPricing()
        â”œâ”€â”€ deleteCustomPricing()
        â”œâ”€â”€ getEffectivePrice()
        â”œâ”€â”€ DEFAULT_PRICING
        â””â”€â”€ AVAILABLE_PLANS
```

## ğŸ“Š Database Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      profiles       â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id (PK)             â”‚â—„â”€â”€â”€â”€â”€â”€â”
â”‚ email               â”‚       â”‚
â”‚ full_name           â”‚       â”‚
â”‚ role                â”‚       â”‚
â”‚ ...                 â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
         â–³                    â”‚
         â”‚                    â”‚
         â”‚ created_by         â”‚ user_id
         â”‚                    â”‚
         â”‚                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”
â”‚      custom_pricing              â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id (PK)                          â”‚
â”‚ user_id (FK) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ plan_name                        â”‚
â”‚ price_per_page                   â”‚
â”‚ currency                         â”‚
â”‚ notes                            â”‚
â”‚ created_by (FK) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ created_at                       â”‚
â”‚ updated_at                       â”‚
â”‚                                  â”‚
â”‚ UNIQUE(user_id, plan_name)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ State Machine Diagram

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   INITIAL    â”‚
                    â”‚   (Empty)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ Admin navigates to page
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   LOADING    â”‚
                    â”‚ (Fetching)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                     â”‚
       Success  â”‚                     â”‚  Error
                â–¼                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    LOADED    â”‚      â”‚    ERROR     â”‚
        â”‚  (Display)   â”‚      â”‚   (Show msg) â”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ Admin clicks Add/Edit
               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ MODAL OPEN   â”‚
        â”‚ (Form shown) â”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ Admin submits
               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   SAVING     â”‚
        â”‚ (Processing) â”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
        â”‚             â”‚
Success â”‚             â”‚ Error
        â–¼             â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚   SUCCESS    â”‚  â”‚ SAVE ERROR   â”‚
 â”‚ (Modal close)â”‚  â”‚(Show error)  â”‚
 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ Refresh data
        â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚    LOADED    â”‚
 â”‚  (Updated)   â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¨ UI Component Tree

```
UserDetailPage
â”‚
â”œâ”€â”€ Tabs Navigation
â”‚   â”œâ”€â”€ Overview Tab
â”‚   â”œâ”€â”€ Custom Pricing Tab â—„â”€â”€ NEW
â”‚   â”œâ”€â”€ Onboarding Tab
â”‚   â”œâ”€â”€ Applications Tab
â”‚   â”œâ”€â”€ Documents Tab
â”‚   â””â”€â”€ Payments Tab
â”‚
â””â”€â”€ Tab Content
    â””â”€â”€ Custom Pricing Tab Content
        â”‚
        â”œâ”€â”€ Header Section
        â”‚   â”œâ”€â”€ Title + Icon
        â”‚   â””â”€â”€ Add Button
        â”‚
        â”œâ”€â”€ Content Section
        â”‚   â”‚
        â”‚   â”œâ”€â”€ Loading State
        â”‚   â”‚   â””â”€â”€ Spinner + Message
        â”‚   â”‚
        â”‚   â”œâ”€â”€ Empty State
        â”‚   â”‚   â”œâ”€â”€ Icon
        â”‚   â”‚   â””â”€â”€ Message
        â”‚   â”‚
        â”‚   â””â”€â”€ Pricing List
        â”‚       â””â”€â”€ Pricing Cards (map)
        â”‚           â”œâ”€â”€ Plan Badge
        â”‚           â”œâ”€â”€ Price Display
        â”‚           â”œâ”€â”€ Notes
        â”‚           â”œâ”€â”€ Metadata
        â”‚           â””â”€â”€ Actions
        â”‚               â”œâ”€â”€ Edit Button
        â”‚               â””â”€â”€ Delete Button
        â”‚
        â””â”€â”€ Footer Section
            â””â”€â”€ Default Pricing Reference
                â””â”€â”€ Plan Cards (map)
                    â”œâ”€â”€ Plan Label
                    â””â”€â”€ Default Price
```

## ğŸ“± API Request/Response Flow

### GET Request
```
Request:
  GET /api/admin/custom-pricing?userId={uuid}
  Headers:
    Authorization: Bearer {token}

Response (Success):
  {
    "success": true,
    "data": [
      {
        "id": "uuid",
        "user_id": "uuid",
        "plan_name": "gold",
        "price_per_page": 559,
        "currency": "USD",
        "notes": "VIP discount - 20% off",
        "created_by": "uuid",
        "created_at": "2025-01-24T10:00:00Z",
        "updated_at": "2025-01-24T10:00:00Z",
        "created_by_profile": {
          "full_name": "Admin Name",
          "email": "admin@example.com"
        }
      }
    ]
  }

Response (Error):
  {
    "success": false,
    "error": "Admin access required"
  }
```

### POST Request
```
Request:
  POST /api/admin/custom-pricing
  Headers:
    Authorization: Bearer {token}
    Content-Type: application/json
  Body:
    {
      "userId": "uuid",
      "planName": "diamond",
      "pricePerPage": 1200,
      "currency": "USD",
      "notes": "Partner program - special pricing"
    }

Response (Success):
  {
    "success": true,
    "data": { /* pricing object */ },
    "message": "Custom pricing created successfully"
  }
```

### DELETE Request
```
Request:
  DELETE /api/admin/custom-pricing?pricingId={uuid}
  Headers:
    Authorization: Bearer {token}

Response (Success):
  {
    "success": true,
    "message": "Custom pricing deleted successfully"
  }
```

## ğŸ”§ Technology Stack

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          FRONTEND                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ React (Next.js)                     â”‚
â”‚ â€¢ Lucide React Icons                  â”‚
â”‚ â€¢ Tailwind CSS (styling)              â”‚
â”‚ â€¢ Context API (auth)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          BACKEND                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Next.js API Routes                  â”‚
â”‚ â€¢ Node.js                             â”‚
â”‚ â€¢ Supabase Client                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          DATABASE                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Supabase (PostgreSQL)               â”‚
â”‚ â€¢ Row Level Security                  â”‚
â”‚ â€¢ Triggers & Functions                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ File Structure

```
FALCON-GLOBAL-CONSULTING/
â”‚
â”œâ”€â”€ supabase/
â”‚   â””â”€â”€ migrations/
â”‚       â””â”€â”€ 20250124_add_custom_pricing.sql
â”‚
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ admin/
â”‚   â”‚       â””â”€â”€ custom-pricing.js
â”‚   â”‚
â”‚   â””â”€â”€ dashboard/
â”‚       â””â”€â”€ admin/
â”‚           â””â”€â”€ user/
â”‚               â””â”€â”€ [userId].js (modified)
â”‚
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ custom-pricing.js
â”‚
â””â”€â”€ Documentation/
    â”œâ”€â”€ CUSTOM_PRICING_README.md
    â”œâ”€â”€ QUICK_START_CUSTOM_PRICING.md
    â”œâ”€â”€ CUSTOM_PRICING_TEST_GUIDE.md
    â”œâ”€â”€ CUSTOM_PRICING_IMPLEMENTATION_SUMMARY.md
    â””â”€â”€ CUSTOM_PRICING_ARCHITECTURE.md (this file)
```

## ğŸ¯ Key Design Decisions

1. **Unique Constraint**: `(user_id, plan_name)` prevents duplicate plans per user
2. **Service Role**: Used for privileged operations with RLS
3. **Audit Trail**: `created_by` and timestamps track changes
4. **Cascade Delete**: Pricing removed when user is deleted
5. **Currency Support**: Text field allows flexibility
6. **Notes Field**: Optional for admin documentation
7. **Modal UI**: Better UX than inline editing
8. **Default Reference**: Helps admins see standard pricing

---

This architecture provides a scalable, secure, and maintainable custom pricing system.
